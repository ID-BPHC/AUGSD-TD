extends ../../../../master-dashboard

block content
	div.mdl-grid
		div.mdl-cell.mdl-cell--12-col
			h2 Room Map Management
		div.mdl-cell.mdl-cell--12-col
			center
				.mdl-cell.mdl-cell--12-col
					// Search box
					.mdl-textfield.mdl-js-textfield.mdl-textfield--floating-label(style="width: 100%; max-width: 400px; margin-bottom: 20px;")
						input#roomSearch.mdl-textfield__input(type='text', value='#{searchQuery || ""}', placeholder='Search rooms...')
						label.mdl-textfield__label(for='roomSearch') Search Rooms
						i.material-icons.mdl-textfield__icon(id='searchIcon', style='cursor: pointer;') search
					
					form(action="#{rootURL}/control/room-map/step2", method="post", name="form1" id="form1").mdc-form-field
						.mdl-textfield.mdl-js-textfield.mdl-textfield--floating-label.getmdl-select.getmdl-select__fix-height.mdc-form-field.getmdl-select__fullwidth
							input#rooms.mdl-textfield__input(type='text', value='', readonly='', tabindex='-1', name='room')
							label(for='rooms')
								i.mdl-icon-toggle__label.material-icons keyboard_arrow_down
							label.mdl-textfield__label Select Room
							ul#roomList.mdl-menu.mdl-menu--bottom-left.mdl-js-menu(for='rooms')
								each room in result
									li.mdl-menu__item(data-val='#{room}') #{room} 
					button.mdl-button.mdl-js-button.mdl-js-ripple-effect.mdl-button--colored.mdl-button--raised(data-stepper-next='', data-upgraded=',MaterialButton,MaterialRipple',type="submit",form="form1")
						| Continue
						span.mdl-button__ripple-container
							span.mdl-ripple
					button.mdl-button.mdl-js-button.mdl-js-ripple-effect(data-stepper-cancel='', data-upgraded=',MaterialButton,MaterialRipple', onclick="window.location.replace('#{rootURL}')")
						| Cancel
						span.mdl-button__ripple-container
							span.mdl-ripple

	script.
		document.addEventListener('DOMContentLoaded', function() {
			const searchInput = document.getElementById('roomSearch');
			const roomList = document.getElementById('roomList');
			const roomsInput = document.getElementById('rooms');
			let searchTimeout;
			let allRooms = !{JSON.stringify(allRooms || result)};

			function filterRooms(searchTerm) {
				// Clear existing room list
				roomList.innerHTML = '';
				
				// Filter rooms based on search term
				const filteredRooms = allRooms.filter(room => 
					room.toLowerCase().includes(searchTerm.toLowerCase())
				);
				
				// Add filtered rooms to the dropdown
				filteredRooms.forEach(room => {
					const li = document.createElement('li');
					li.className = 'mdl-menu__item';
					li.setAttribute('data-val', room);
					li.textContent = room;
					roomList.appendChild(li);
				});
				
				// Reinitialize MDL menu if needed
				if (window.componentHandler) {
					window.componentHandler.upgradeElement(roomList);
				}
			}

			function performSearch() {
				const searchTerm = searchInput.value.trim();
				
				if (searchTerm === '') {
					// Show all rooms if search is empty
					filterRooms('');
				} else {
					// Filter rooms locally for instant results
					filterRooms(searchTerm);
				}
			}

			// Add event listeners
			searchInput.addEventListener('input', function() {
				clearTimeout(searchTimeout);
				searchTimeout = setTimeout(performSearch, 300); // Debounce search
			});

			searchInput.addEventListener('keypress', function(e) {
				if (e.key === 'Enter') {
					e.preventDefault();
					performSearch();
				}
			});

			// Clear search functionality
			document.getElementById('searchIcon').addEventListener('click', function() {
				if (searchInput.value) {
					searchInput.value = '';
					performSearch();
					searchInput.focus();
				}
			});
		});